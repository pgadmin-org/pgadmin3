<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>Slony-I FAQ</title>
<link rel="stylesheet" href="stylesheet.css" type="text/css">
<link rev="made" href="pgsql-docs@postgresql.org">
<meta name="generator" content="DocBook XSL Stylesheets V1.66.1">
<link rel="start" href="index.html" title="Slony-I HEAD_20050707 Documentation">
<link rel="up" href="index.html" title="Slony-I HEAD_20050707 Documentation">
<link rel="prev" href="help.html" title="21. More Slony-I Help">
<link rel="next" href="commandreference.html" title="Part I. Core Slony-I Programs">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="article" lang="en" id="faq">
<div class="titlepage">
<div>
<div><h2 class="title">
<a name="faq"></a>Slony-I FAQ</h2></div>
<div><h3 class="corpauthor">The Slony Global Development Group</h3></div>
<div><div class="author"><h3 class="author">
<span class="firstname">Christopher </span> <span class="surname">Browne</span>
</h3></div></div>
</div>
<hr>
</div>
<p> Not all of these are, strictly speaking, &#8220;<span class="quote">frequently
asked;</span>&#8221; some represent <span class="emphasis"><em>trouble found that seemed
worth documenting</em></span>.</p>
<div class="qandaset">
<dl>
<dt>1. <a href="faq.html#missingheaders"> I tried building Slony-I 1.1 and got the following
error message:
configure: error: Headers for libpqserver are not found in the includeserverdir.
   This is the path to postgres.h. Please specify the includeserverdir with
   --with-pgincludeserverdir=&lt;dir&gt;</a>
</dt>
<dt>2. <a href="faq.html#id2546437">I looked for the _clustername namespace, and
it wasn't there.</a>
</dt>
<dt>3. <a href="faq.html#threadsafety"> Some events are moving around, but no replication is
taking place.</a>
</dt>
<dt>4. <a href="faq.html#id2546646">I tried creating a CLUSTER NAME with a "-" in it.
That didn't work.</a>
</dt>
<dt>5. <a href="faq.html#id2546677">  does not restart after
crash</a>
</dt>
<dt>6. <a href="faq.html#id2546783">ps finds passwords on command line</a>
</dt>
<dt>7. <a href="faq.html#id2546806">Slonik fails - cannot load
PostgreSQL library -
PGRES_FATAL_ERROR load '$libdir/xxid';</a>
</dt>
<dt>8. <a href="faq.html#id2546974">Table indexes with FQ namespace names

set add table (set id = 1, origin = 1, id = 27, 
               full qualified name = 'nspace.some_table', 
               key = 'key_on_whatever', 
               comment = 'Table some_table in namespace nspace with a candidate primary key');</a>
</dt>
<dt>9. <a href="faq.html#id2547001"> I'm trying to get a slave subscribed, and get the
following messages in the logs:

DEBUG1 copy_set 1
DEBUG1 remoteWorkerThread_1: connected to provider DB
WARN	remoteWorkerThread_1: transactions earlier than XID 127314958 are still in progress
WARN	remoteWorkerThread_1: data copy for set 1 failed - sleep 60 seconds</a>
</dt>
<dt>10. <a href="faq.html#id2547125">ERROR: duplicate key violates unique constraint "sl_table-pkey"</a>
</dt>
<dt>11. <a href="faq.html#id2547162">I need to drop a table from a replication set</a>
</dt>
<dt>12. <a href="faq.html#id2547257">I need to drop a sequence from a replication set</a>
</dt>
<dt>13. <a href="faq.html#id2547360">Slony-I: cannot add table to currently subscribed set 1</a>
</dt>
<dt>14. <a href="faq.html#pglistenerfull">Some nodes start consistently falling behind</a>
</dt>
<dt>15. <a href="faq.html#id2547486">I started doing a backup using
pg_dump, and suddenly Slony
stops</a>
</dt>
<dt>16. <a href="faq.html#id2547662">The slon spent the weekend out of
commission [for some reason], and it's taking a long time to get a
sync through.</a>
</dt>
<dt>17. <a href="faq.html#id2547760">I pointed a subscribing node to a different provider
and it stopped replicating</a>
</dt>
<dt>18. <a href="faq.html#faq17">After dropping a node, 
isn't getting purged out anymore.</a>
</dt>
<dt>19. <a href="faq.html#dupkey">Replication Fails - Unique Constraint Violation</a>
</dt>
<dt>20. <a href="faq.html#id2548394"> If you have a  script
something like this, it will hang on you and never complete, because
you can't have wait for event inside a
try block. A try block is
executed as one transaction, and the event that you are waiting for
can never arrive inside the scope of the transaction.</a>
</dt>
<dt>21. <a href="faq.html#id2548452"> Is the ordering of tables in a set significant?</a>
</dt>
<dt>22. <a href="faq.html#id2548523"> What happens with rules and triggers on
Slony-I-replicated tables?</a>
</dt>
<dt>23. <a href="faq.html#id2548700"> After notification of a subscription on
another node, replication falls over, starting
with the following error message:</a>
</dt>
<dt>24. <a href="faq.html#id2548800">I just used  to move the
origin to a new node.  Unfortunately, some subscribers are still
pointing to the former origin node, so I can't take it out of service
for maintenance without stopping them from getting updates.  What do I
do?  </a>
</dt>
<dt>25. <a href="faq.html#longtxnsareevil"> Replication has been slowing down, I'm seeing
 FETCH 100 FROM LOG  queries running for a long
time,  is growing, and performance is,
well, generally getting steadily worse. </a>
</dt>
<dt>26. <a href="faq.html#neededexecddl"> Behaviour - all the subscriber nodes start to fall
behind the origin, and all the logs on the subscriber nodes have the
following error message repeating in them (when I encountered it,
there was a nice long SQL statement above each entry):</a>
</dt>
<dt>27. <a href="faq.html#id2549133"> After notification of a subscription on
another node, replication falls over on one of
the subscribers, with the following error message:</a>
</dt>
<dt>28. <a href="faq.html#id2549232"> I can do a pg_dump
and load the data back in much faster than the SUBSCRIBE
SET runs.  Why is that?  </a>
</dt>
<dt>29. <a href="faq.html#id2549350"> I had a network glitch that led to my
using  to fail over to an alternate node.
The failure wasn't a disk problem that would corrupt databases; why do
I need to rebuild the failed node from scratch? </a>
</dt>
<dt>30. <a href="faq.html#morethansuper"> I created a superuser account,
slony, to run replication activities.  As
suggested, I set it up as a superuser, via the following query: 
update pg_shadow set usesuper = 't' where usename in ('slony',
'molly', 'dumpy');
(that command also deals with other users I set up to run vacuums and
backups).</a>
</dt>
<dt>31. <a href="faq.html#missingoids"> We got bitten by
something we didn't foresee when completely uninstalling a slony
replication cluster from the master and slave...</a>
</dt>
<dt>32. <a href="faq.html#id2549601"> Node #1 was dropped via , and the  one of the
other nodes is repeatedly failing with the error message:</a>
</dt>
<dt>33. <a href="faq.html#id2549736"> I am using  Frotznik Freenix
4.5, with its FFPM (Frotznik Freenix
Package Manager) package management system.  It comes with
FFPM packages for PostgreSQL 7.4.7, which are what
I am using for my databases, but they don't include Slony-I in the
packaging.  How do I add Slony-I to this?  </a>
</dt>
<dt>34. <a href="faq.html#sequenceset"> Bug #1226  indicates an error condition that can come up if
you have a replication set that consists solely of sequences. </a>
</dt>
<dt>35. <a href="faq.html#id2550114"> I tried the following query which did not work:</a>
</dt>
<dt>36. <a href="faq.html#v72upgrade"> I have a PostgreSQL 7.2-based system that I
really, really want to use Slony-I to help me
upgrade it to 8.0.  What is involved in getting Slony-I to work for
that?</a>
</dt>
<dt>37. <a href="faq.html#id2550392"> I am finding some multibyte columns (Unicode, Big5)
are being truncated.  Why?  </a>
</dt>
<dt>38. <a href="faq.html#id2550424"> I need to rename a column that is in the
primary key for one of my replicated tables.  That seems pretty
dangerous, doesn't it?  I have to drop the table out of replication
and recreate it, right?</a>
</dt>
<dt>39. <a href="faq.html#id2550522"> Replication has fallen behind, and it appears that the
queries to draw data from / are taking a long time to pull just a few
SYNCs. </a>
</dt>
</dl>
<a name="id2546362"></a><table border="0" summary="Q and A Set">
<col align="left" width="1%">
<tbody>
<tr class="question">
<td align="left" valign="top">
<a name="missingheaders"></a><a name="id2546378"></a><b>1.</b>
</td>
<td align="left" valign="top">
<p> I tried building <span class="productname">Slony-I</span> 1.1 and got the following
error message:
</p>
<pre class="screen">configure: error: Headers for libpqserver are not found in the includeserverdir.
   This is the path to postgres.h. Please specify the includeserverdir with
   --with-pgincludeserverdir=&lt;dir&gt;</pre>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"><b></b></td>
<td align="left" valign="top">
<p> You are almost certainly running version <span class="productname">PostgreSQL</span> 7.4
or earlier, where server headers are not installed by default if you
just do a <tt class="command">make install</tt> of <span class="productname">PostgreSQL</span>.</p>
<p> You need to install server headers when you install <span class="productname">PostgreSQL</span>
via the command <tt class="command">make install-all-headers</tt>.
</p>
</td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2546437"></a><a name="id2546438"></a><b>2.</b>
</td>
<td align="left" valign="top"><p>I looked for the <tt class="envar">_clustername</tt> namespace, and
it wasn't there.</p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"><b></b></td>
<td align="left" valign="top">
<p> If the DSNs are wrong, then <a href="slon.html" title="slon"><span class="refentrytitle"><a name="app-slon-title"></a><span class="application">slon</span></span></a>
instances can't connect to the nodes.</p>
<p>This will generally lead to nodes remaining entirely untouched.</p>
<p>Recheck the connection configuration.  By the way, since <a href="slon.html" title="slon"><span class="refentrytitle"><a name="app-slon-title"></a><span class="application">slon</span></span></a> links to libpq, you could have password information
stored in <tt class="filename"> $HOME/.pgpass</tt>, partially filling in
right/wrong authentication information there.</p>
</td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="threadsafety"></a><a name="id2546481"></a><b>3.</b>
</td>
<td align="left" valign="top">
<p> Some events are moving around, but no replication is
taking place.</p>
<p> Slony logs might look like the following:

</p>
<pre class="screen">DEBUG1 remoteListenThread_1: connected to 'host=host004 dbname=pgbenchrep user=postgres port=5432'
ERROR  remoteListenThread_1: "select ev_origin, ev_seqno, ev_timestamp,
		  ev_minxid, ev_maxxid, ev_xip,
		  ev_type,
                  ev_data1, ev_data2,
		  ev_data3, ev_data4,
 	          ev_data5, ev_data6,
		  ev_data7, ev_data8 from "_pgbenchtest".sl_event e 
where (e.ev_origin = '1' and e.ev_seqno &gt; '1') order by e.ev_origin, e.ev_seqno" - could not receive data from server: Operation now in progress</pre>
<p> Alternatively, it may appear like...

</p>
<pre class="screen">ERROR  remoteListenThread_2: "select ev_origin, ev_seqno, ev_timestamp,
ev_minxid, ev_maxxid, ev_xip,        ev_type,        ev_data1, ev_data2,
ev_data3, ev_data4,        ev_data5, ev_data6,        ev_data7, ev_data8
from "_sl_p2t2".sl_event e where (e.ev_origin = '2' and e.ev_seqno &gt;
'0') order by e.ev_origin, e.ev_seqno" - could not receive data from
server: Error 0</pre>
<p> </p>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"><b></b></td>
<td align="left" valign="top">
<p>On AIX and Solaris (and possibly elsewhere), both
<span class="productname">Slony-I</span> <span class="emphasis"><em>and <span class="productname">PostgreSQL</span></em></span> must be compiled with the
<tt class="option">--enable-thread-safety</tt> option.  The above results
when <span class="productname">PostgreSQL</span> isn't so compiled.</p>
<p>What breaks here is that the libc (threadsafe) and libpq
(non-threadsafe) use different memory locations for errno, thereby
leading to the request failing.</p>
<p>Problems like this crop up with disadmirable regularity on AIX
and Solaris; it may take something of an &#8220;<span class="quote">object code audit</span>&#8221; to
make sure that <span class="emphasis"><em>ALL</em></span> of the necessary components have been
compiled and linked with <tt class="option">--enable-thread-safety</tt>.</p>
<p>For instance, I ran into the problem one that
<tt class="envar">LD_LIBRARY_PATH</tt> had been set, on Solaris, to point to
libraries from an old <span class="productname">PostgreSQL</span> compile.  That meant that even though
the database <span class="emphasis"><em>had</em></span> been compiled with
<tt class="option">--enable-thread-safety</tt>, and
<span class="application">slon</span> had been compiled against that,
<span class="application">slon</span> was being dynamically linked to the
&#8220;<span class="quote">bad old thread-unsafe version,</span>&#8221; so slon didn't work.  It
wasn't clear that this was the case until I ran <tt class="command">ldd</tt>
against <span class="application">slon</span>.</p>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"><b></b></td>
<td align="left" valign="top"><p> Note that with libpq version 7.4.2, on Solaris, a
further <a href="installation.html#threadpatch"> thread patch </a> was
required; similar is also required for <span class="productname">PostgreSQL</span> version 8.0.</p></td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2546646"></a><a name="id2546647"></a><b>4.</b>
</td>
<td align="left" valign="top"><p>I tried creating a CLUSTER NAME with a "-" in it.
That didn't work.</p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"><b></b></td>
<td align="left" valign="top">
<p> <span class="productname">Slony-I</span> uses the same rules for unquoted identifiers
as the <span class="productname">PostgreSQL</span> main parser, so no, you probably shouldn't put a "-"
in your identifier name.</p>
<p> You may be able to defeat this by putting &#8220;<span class="quote">quotes</span>&#8221; around
identifier names, but it's still liable to bite you some, so this is
something that is probably not worth working around.</p>
</td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2546677"></a><a name="id2546678"></a><b>5.</b>
</td>
<td align="left" valign="top">
<p> <a href="slon.html" title="slon"><span class="refentrytitle"><a name="app-slon-title"></a><span class="application">slon</span></span></a> does not restart after
crash</p>
<p> After an immediate stop of postgresql (simulation of system
crash) in pg_catalog.pg_listener a tuple with
relname='_${cluster_name}_Restart' exists. slon doesn't start because
it thinks another process is serving the cluster on this node.  What
can I do? The tuples can't be dropped from this relation.</p>
<p> The logs claim that </p>
<div class="blockquote"><blockquote class="blockquote"><p>Another slon daemon is
serving this node already</p></blockquote></div>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"><b></b></td>
<td align="left" valign="top">
<p> The problem is that the system table
<tt class="envar">pg_catalog.pg_listener</tt>, used by
<span class="productname">PostgreSQL</span> to manage event notifications,
contains some entries that are pointing to backends that no longer
exist.  The new <a href="slon.html" title="slon"><span class="refentrytitle"><a name="app-slon-title"></a><span class="application">slon</span></span></a> instance connects to the
database, and is convinced, by the presence of these entries, that an
old <span class="application">slon</span> is still servicing this <span class="productname">Slony-I</span>
node.</p>
<p> The &#8220;<span class="quote">trash</span>&#8221; in that table needs to be thrown away.</p>
<p>It's handy to keep a slonik script similar to the following to
run in such cases:

</p>
<pre class="programlisting">twcsds004[/opt/twcsds004/OXRS/slony-scripts]$ cat restart_org.slonik 
cluster name = oxrsorg ;
node 1 admin conninfo = 'host=32.85.68.220 dbname=oxrsorg user=postgres port=5532';
node 2 admin conninfo = 'host=32.85.68.216 dbname=oxrsorg user=postgres port=5532';
node 3 admin conninfo = 'host=32.85.68.244 dbname=oxrsorg user=postgres port=5532';
node 4 admin conninfo = 'host=10.28.103.132 dbname=oxrsorg user=postgres port=5532';
restart node 1;
restart node 2;
restart node 3;
restart node 4;</pre>
<p> <a href="stmtrestartnode.html" title="RESTART NODE"><span class="refentrytitle">RESTART NODE</span></a> cleans up dead notifications
so that you can restart the node.</p>
<p>As of version 1.0.5, the startup process of slon looks for this
condition, and automatically cleans it up.</p>
</td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2546783"></a><a name="id2546784"></a><b>6.</b>
</td>
<td align="left" valign="top">
<p>ps finds passwords on command line</p>
<p> If I run a <tt class="command">ps</tt> command, I, and everyone else,
can see passwords on the command line.</p>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"><b></b></td>
<td align="left" valign="top"><p>Take the passwords out of the Slony configuration, and
put them into <tt class="filename">$(HOME)/.pgpass.</tt></p></td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2546806"></a><a name="id2546807"></a><b>7.</b>
</td>
<td align="left" valign="top">
<p>Slonik fails - cannot load
<span class="productname">PostgreSQL</span> library -
<tt class="command">PGRES_FATAL_ERROR load '$libdir/xxid';</tt></p>
<p> When I run the sample setup script I get an error message similar
to:

<tt class="command">stdin:64: PGRES_FATAL_ERROR load '$libdir/xxid';  - ERROR:  LOAD:
could not open file '$libdir/xxid': No such file or directory</tt></p>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"><b></b></td>
<td align="left" valign="top">
<p> Evidently, you haven't got the
<tt class="filename">xxid.so</tt> library in the <tt class="envar">$libdir</tt>
directory that the <span class="productname">PostgreSQL</span> instance is
using.  Note that the <span class="productname">Slony-I</span> components
need to be installed in the <span class="productname">PostgreSQL</span>
software installation for <span class="emphasis"><em>each and every one</em></span> of
the nodes, not just on the origin node.</p>
<p>This may also point to there being some other mismatch between
the <span class="productname">PostgreSQL</span> binary instance and the <span class="productname">Slony-I</span> instance.  If you
compiled <span class="productname">Slony-I</span> yourself, on a machine that may have multiple
<span class="productname">PostgreSQL</span> builds &#8220;<span class="quote">lying around,</span>&#8221; it's possible that the
slon or slonik binaries are asking to load something that isn't
actually in the library directory for the <span class="productname">PostgreSQL</span> database cluster
that it's hitting.</p>
<p>Long and short: This points to a need to &#8220;<span class="quote">audit</span>&#8221;
what installations of <span class="productname">PostgreSQL</span> and <span class="productname">Slony-I</span> you have in place on the
machine(s).  Unfortunately, just about any mismatch will cause things
not to link up quite right.  See also <a href="faq.html#threadsafety">thread safety </a> concerning threading issues on Solaris
...</p>
<p> Life is simplest if you only have one set of <span class="productname">PostgreSQL</span>
binaries on a given server; in that case, there isn't a &#8220;<span class="quote">wrong
place</span>&#8221; in which <span class="productname">Slony-I</span> components might get installed.  If
you have several software installs, you'll have to verify that the
right versions of <span class="productname">Slony-I</span> components are associated with the right
<span class="productname">PostgreSQL</span> binaries. </p>
</td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2546974"></a><a name="id2546975"></a><b>8.</b>
</td>
<td align="left" valign="top">
<p>Table indexes with FQ namespace names

</p>
<pre class="programlisting">set add table (set id = 1, origin = 1, id = 27, 
               full qualified name = 'nspace.some_table', 
               key = 'key_on_whatever', 
               comment = 'Table some_table in namespace nspace with a candidate primary key');</pre>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"><b></b></td>
<td align="left" valign="top"><p> If you have <tt class="command"> key =
'nspace.key_on_whatever'</tt> the request will
<span class="emphasis"><em>FAIL</em></span>.</p></td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2547001"></a><a name="id2547002"></a><b>9.</b>
</td>
<td align="left" valign="top">
<p> I'm trying to get a slave subscribed, and get the
following messages in the logs:

</p>
<pre class="screen">DEBUG1 copy_set 1
DEBUG1 remoteWorkerThread_1: connected to provider DB
WARN	remoteWorkerThread_1: transactions earlier than XID 127314958 are still in progress
WARN	remoteWorkerThread_1: data copy for set 1 failed - sleep 60 seconds</pre>
<p>Oops.  What I forgot to mention, as well, was that I was trying
to add <span class="emphasis"><em>TWO</em></span> subscribers, concurrently.</p>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"><b></b></td>
<td align="left" valign="top">
<p> That doesn't work out: <span class="productname">Slony-I</span> won't work on the
<tt class="command">COPY</tt> commands concurrently.  See
<tt class="filename">src/slon/remote_worker.c</tt>, function
<tt class="function">copy_set()</tt></p>
<p>This has the (perhaps unfortunate) implication that you cannot
populate two slaves concurrently from a single provider.  You have to
subscribe one to the set, and only once it has completed setting up
the subscription (copying table contents and such) can the second
subscriber start setting up the subscription.</p>
<p>It could also be possible for there to be an old outstanding
transaction blocking <span class="productname">Slony-I</span> from processing the sync.  You might
want to take a look at pg_locks to see what's up:

</p>
<pre class="screen">sampledb=# select * from pg_locks where transaction is not null order by transaction;
 relation | database | transaction |  pid    |     mode      | granted 
----------+----------+-------------+---------+---------------+---------
          |          |   127314921 | 2605100 | ExclusiveLock | t
          |          |   127326504 | 5660904 | ExclusiveLock | t
(2 rows)</pre>
<p>See?  127314921 is indeed older than 127314958, and it's still running.

</p>
<pre class="screen">$ ps -aef | egrep '[2]605100'
postgres 2605100  205018	0 18:53:43  pts/3  3:13 postgres: postgres sampledb localhost COPY </pre>
<p>This happens to be a <tt class="command">COPY</tt> transaction involved in setting up the
subscription for one of the nodes.  All is well; the system is busy
setting up the first subscriber; it won't start on the second one
until the first one has completed subscribing.</p>
<p>By the way, if there is more than one database on the <span class="productname">PostgreSQL</span>
cluster, and activity is taking place on the OTHER database, that will
lead to there being &#8220;<span class="quote">transactions earlier than XID
whatever</span>&#8221; being found to be still in progress.  The fact that
it's a separate database on the cluster is irrelevant; <span class="productname">Slony-I</span> will
wait until those old transactions terminate.</p>
</td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2547125"></a><a name="id2547126"></a><b>10.</b>
</td>
<td align="left" valign="top">
<p>ERROR: duplicate key violates unique constraint "sl_table-pkey"</p>
<p>I tried setting up a second replication set, and got the following error:

</p>
<pre class="screen">stdin:9: Could not create subscription set 2 for oxrslive!
stdin:11: PGRES_FATAL_ERROR select "_oxrslive".setAddTable(2, 1, 'public.replic_test', 'replic_test__Slony-I_oxrslive_rowID_key', 'Table public.replic_test without primary key');  - ERROR:  duplicate key violates unique constraint "sl_table-pkey"
CONTEXT:  PL/pgSQL function "setaddtable_int" line 71 at SQL statement</pre>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"><b></b></td>
<td align="left" valign="top"><p> The table IDs used in <a href="stmtsetaddtable.html" title="SET ADD TABLE"><span class="refentrytitle">SET ADD TABLE</span></a>
are required to be unique <span class="emphasis"><em>ACROSS ALL SETS</em></span>.  Thus,
you can't restart numbering at 1 for a second set; if you are
numbering them consecutively, a subsequent set has to start with IDs
after where the previous set(s) left off.</p></td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2547162"></a><a name="id2547163"></a><b>11.</b>
</td>
<td align="left" valign="top"><p>I need to drop a table from a replication set</p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"><b></b></td>
<td align="left" valign="top">
<p>This can be accomplished several ways, not all equally desirable ;-).

</p>
<div class="itemizedlist"><ul type="disc">
<li><p> You could drop the whole replication set, and
recreate it with just the tables that you need.  Alas, that means
recopying a whole lot of data, and kills the usability of the cluster
on the rest of the set while that's happening.</p></li>
<li><p> If you are running 1.0.5 or later, there is the
command SET DROP TABLE, which will "do the trick."</p></li>
<li>
<p> If you are still using 1.0.1 or 1.0.2, the
<span class="emphasis"><em>essential functionality of <a href="stmtsetdroptable.html" title="SET DROP TABLE"><span class="refentrytitle">SET DROP TABLE</span></a>
involves the functionality in <tt class="function">droptable_int()</tt>.
You can fiddle this by hand by finding the table ID for the table you
want to get rid of, which you can find in <a href="table.sl-table.html">sl_table</a>, and then run the
following three queries, on each host:</em></span>

</p>
<pre class="programlisting">  select _slonyschema.alterTableRestore(40);
  select _slonyschema.tableDropKey(40);
  delete from _slonyschema.sl_table where tab_id = 40;</pre>
<p>The schema will obviously depend on how you defined the <span class="productname">Slony-I</span>
cluster.  The table ID, in this case, 40, will need to change to the
ID of the table you want to have go away.</p>
<p> You'll have to run these three queries on all of the nodes,
preferably firstly on the origin node, so that the dropping of this
propagates properly.  Implementing this via a <a href="slonik.html" title="slonik"><span class="refentrytitle"><a name="app-slonik-title"></a><span class="application">slonik</span></span></a>
statement with a new <span class="productname">Slony-I</span> event would do that.  Submitting the
three queries using <a href="stmtddlscript.html" title="EXECUTE SCRIPT"><span class="refentrytitle">EXECUTE SCRIPT</span></a> could do that.
Also possible would be to connect to each database and submit the
queries by hand.</p>
</li>
</ul></div>
</td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2547257"></a><a name="id2547258"></a><b>12.</b>
</td>
<td align="left" valign="top"><p>I need to drop a sequence from a replication set</p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"><b></b></td>
<td align="left" valign="top">
<p></p>
<p>If you are running 1.0.5 or later, there is
a <a href="stmtsetdropsequence.html" title="SET DROP SEQUENCE"><span class="refentrytitle">SET DROP SEQUENCE</span></a> command in Slonik to allow you
to do this, parallelling <a href="stmtsetdroptable.html" title="SET DROP TABLE"><span class="refentrytitle">SET DROP TABLE</span></a>.</p>
<p>If you are running 1.0.2 or earlier, the process is a bit more manual.</p>
<p>Supposing I want to get rid of the two sequences listed below,
<tt class="envar">whois_cachemgmt_seq</tt> and
<tt class="envar">epp_whoi_cach_seq_</tt>, we start by needing the
<tt class="envar">seq_id</tt> values.

</p>
<pre class="screen">oxrsorg=# select * from _oxrsorg.sl_sequence  where seq_id in (93,59);
 seq_id | seq_reloid | seq_set |       seq_comment				 
--------+------------+---------+-------------------------------------
     93 |  107451516 |       1 | Sequence public.whois_cachemgmt_seq
     59 |  107451860 |       1 | Sequence public.epp_whoi_cach_seq_
(2 rows)</pre>
<p>The data that needs to be deleted to stop Slony from continuing to
replicate these are thus:

</p>
<pre class="programlisting">delete from _oxrsorg.sl_seqlog where seql_seqid in (93, 59);
delete from _oxrsorg.sl_sequence where seq_id in (93,59);</pre>
<p>Those two queries could be submitted to all of the nodes via
<a href="function.ddlscript-integer-text-integer.html">schemadocddlscript( integer, text, integer )</a> / <a href="stmtddlscript.html" title="EXECUTE SCRIPT"><span class="refentrytitle">EXECUTE SCRIPT</span></a>, thus eliminating the sequence everywhere
&#8220;<span class="quote">at once.</span>&#8221; Or they may be applied by hand to each of the
nodes.</p>
<p>Similarly to <a href="stmtsetdroptable.html" title="SET DROP TABLE"><span class="refentrytitle">SET DROP TABLE</span></a>, this is
implemented <span class="productname">Slony-I</span> version 1.0.5 as <a href="stmtsetdropsequence.html" title="SET DROP SEQUENCE"><span class="refentrytitle">SET DROP SEQUENCE</span></a>.</p>
</td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2547360"></a><a name="id2547361"></a><b>13.</b>
</td>
<td align="left" valign="top">
<p>Slony-I: cannot add table to currently subscribed set 1</p>
<p> I tried to add a table to a set, and got the following message:

</p>
<pre class="screen">	Slony-I: cannot add table to currently subscribed set 1</pre>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"><b></b></td>
<td align="left" valign="top">
<p> You cannot add tables to sets that already have
subscribers.</p>
<p>The workaround to this is to create <span class="emphasis"><em>ANOTHER</em></span>
set, add the new tables to that new set, subscribe the same nodes
subscribing to "set 1" to the new set, and then merge the sets
together.</p>
</td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="pglistenerfull"></a><a name="id2547392"></a><b>14.</b>
</td>
<td align="left" valign="top">
<p>Some nodes start consistently falling behind</p>
<p>I have been running <span class="productname">Slony-I</span> on a node for a while, and am
seeing system performance suffering.</p>
<p>I'm seeing long running queries of the form:
</p>
<pre class="screen">	fetch 100 from LOG;</pre>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"><b></b></td>
<td align="left" valign="top">
<p> This can be characteristic of pg_listener (which is the
table containing <tt class="command">NOTIFY</tt> data) having plenty of dead
tuples in it.  That makes <tt class="command">NOTIFY</tt> events take a long
time, and causes the affected node to gradually fall further and
further behind.</p>
<p>You quite likely need to do a <tt class="command">VACUUM FULL</tt> on
<tt class="envar">pg_listener</tt>, to vigorously clean it out, and need to
vacuum <tt class="envar">pg_listener</tt> really frequently.  Once every five
minutes would likely be AOK.</p>
<p> Slon daemons already vacuum a bunch of tables, and
<tt class="filename">cleanup_thread.c</tt> contains a list of tables that
are frequently vacuumed automatically.  In <span class="productname">Slony-I</span> 1.0.2,
<tt class="envar">pg_listener</tt> is not included.  In 1.0.5 and later, it is
regularly vacuumed, so this should cease to be a direct issue.</p>
<p>There is, however, still a scenario where this will still
&#8220;<span class="quote">bite.</span>&#8221; Under MVCC, vacuums cannot delete tuples that
were made &#8220;<span class="quote">obsolete</span>&#8221; at any time after the start time of
the eldest transaction that is still open.  Long running transactions
will cause trouble, and should be avoided, even on subscriber
nodes.</p>
</td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2547486"></a><a name="id2547488"></a><b>15.</b>
</td>
<td align="left" valign="top"><p>I started doing a backup using
<span class="application">pg_dump</span>, and suddenly Slony
stops</p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"><b></b></td>
<td align="left" valign="top">
<p>Ouch.  What happens here is a conflict between:
</p>
<div class="itemizedlist"><ul type="disc">
<li><p> <span class="application">pg_dump</span>, which has taken
out an <tt class="command">AccessShareLock</tt> on all of the tables in the
database, including the <span class="productname">Slony-I</span> ones, and</p></li>
<li><p> A <span class="productname">Slony-I</span> sync event, which wants to grab a
<tt class="command">AccessExclusiveLock</tt> on the table <a href="table.sl-event.html">sl_event</a>.</p></li>
</ul></div>
<p>The initial query that will be blocked is thus:

</p>
<pre class="screen">select "_slonyschema".createEvent('_slonyschema, 'SYNC', NULL);	  </pre>
<p>(You can see this in <tt class="envar">pg_stat_activity</tt>, if you
have query display turned on in
<tt class="filename">postgresql.conf</tt>)</p>
<p>The actual query combination that is causing the lock is from
the function <tt class="function">Slony_I_ClusterStatus()</tt>, found in
<tt class="filename">slony1_funcs.c</tt>, and is localized in the code that
does:

</p>
<pre class="programlisting">  LOCK TABLE %s.sl_event;
  INSERT INTO %s.sl_event (...stuff...)
  SELECT currval('%s.sl_event_seq');</pre>
<p>The <tt class="command">LOCK</tt> statement will sit there and wait
until <tt class="command">pg_dump</tt> (or whatever else has pretty much any
kind of access lock on <a href="table.sl-event.html">sl_event</a>)
completes.</p>
<p>Every subsequent query submitted that touches
<a href="table.sl-event.html">sl_event</a> will block behind the
<tt class="function">createEvent</tt> call.</p>
<p>There are a number of possible answers to this:
</p>
<div class="itemizedlist"><ul type="disc">
<li><p> Have <span class="application">pg_dump</span> specify the
schema dumped using <tt class="option">--schema=whatever</tt>, and don't try
dumping the cluster's schema.</p></li>
<li><p> It would be nice to add an <tt class="option">--exclude-schema</tt>
option to pg_dump to exclude the Slony cluster schema.  Maybe in 8.1...</p></li>
<li><p>Note that 1.0.5 uses a more precise lock that is less
exclusive that alleviates this problem.</p></li>
</ul></div>
</td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2547662"></a><a name="id2547663"></a><b>16.</b>
</td>
<td align="left" valign="top"><p>The <span class="application">slon</span> spent the weekend out of
commission [for some reason], and it's taking a long time to get a
sync through.</p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"><b></b></td>
<td align="left" valign="top">
<p> You might want to take a look at the <a href="table.sl-log-1.html">sl_log_1</a>/<a href="table.sl-log-2.html">sl_log_2</a> tables, and
do a summary to see if there are any really enormous <span class="productname">Slony-I</span>
transactions in there.  Up until at least 1.0.2, there needs to be a
<a href="slon.html" title="slon"><span class="refentrytitle"><a name="app-slon-title"></a><span class="application">slon</span></span></a> connected to the origin in order for
<tt class="command">SYNC</tt> events to be generated.</p>
<p>If none are being generated, then all of the updates until the
next one is generated will collect into one rather enormous <span class="productname">Slony-I</span>
transaction.</p>
<p>Conclusion: Even if there is not going to be a subscriber
around, you <span class="emphasis"><em>really</em></span> want to have a
<span class="application">slon</span> running to service the origin
node.</p>
<p><span class="productname">Slony-I</span> 1.1 provides a stored procedure that allows
<tt class="command">SYNC</tt> counts to be updated on the origin based on a
<span class="application">cron</span> job even if there is no <a href="slon.html" title="slon"><span class="refentrytitle"><a name="app-slon-title"></a><span class="application">slon</span></span></a> daemon running.</p>
</td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2547760"></a><a name="id2547762"></a><b>17.</b>
</td>
<td align="left" valign="top"><p>I pointed a subscribing node to a different provider
and it stopped replicating</p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"><b></b></td>
<td align="left" valign="top">
<p>We noticed this happening when we wanted to re-initialize a node,
where we had configuration thus:

</p>
<div class="itemizedlist"><ul type="disc">
<li><p> Node 1 - provider</p></li>
<li><p> Node 2 - subscriber to node 1 - the node we're reinitializing</p></li>
<li><p> Node 3 - subscriber to node 3 - node that should keep replicating</p></li>
</ul></div>
<p>The subscription for node 3 was changed to have node 1 as
provider, and we did <a href="stmtdropset.html" title="DROP SET"><span class="refentrytitle">DROP SET</span></a> /<a href="stmtsubscribeset.html" title="SUBSCRIBE SET"><span class="refentrytitle">SUBSCRIBE SET</span></a> for node 2 to get it repopulating.</p>
<p>Unfortunately, replication suddenly stopped to node 3.</p>
<p>The problem was that there was not a suitable set of
&#8220;<span class="quote">listener paths</span>&#8221; in <a href="table.sl-listen.html">sl_listen</a> to allow the events from
node 1 to propagate to node 3.  The events were going through node 2,
and blocking behind the <a href="stmtsubscribeset.html" title="SUBSCRIBE SET"><span class="refentrytitle">SUBSCRIBE SET</span></a> event that
node 2 was working on.</p>
<p>The following slonik script dropped out the listen paths where
node 3 had to go through node 2, and added in direct listens between
nodes 1 and 3.

</p>
<pre class="programlisting">cluster name = oxrslive;
 node 1 admin conninfo='host=32.85.68.220 dbname=oxrslive user=postgres port=5432';
 node 2 admin conninfo='host=32.85.68.216 dbname=oxrslive user=postgres port=5432';
 node 3 admin conninfo='host=32.85.68.244 dbname=oxrslive user=postgres port=5432';
 node 4 admin conninfo='host=10.28.103.132 dbname=oxrslive user=postgres port=5432';
try {
  store listen (origin = 1, receiver = 3, provider = 1);
  store listen (origin = 3, receiver = 1, provider = 3);
  drop listen (origin = 1, receiver = 3, provider = 2);
  drop listen (origin = 3, receiver = 1, provider = 2);
}</pre>
<p>Immediately after this script was run, <tt class="command">SYNC</tt>
events started propagating again to node 3.

This points out two principles:
</p>
<div class="itemizedlist"><ul type="disc">
<li><p> If you have multiple nodes, and cascaded subscribers,
you need to be quite careful in populating the <a href="stmtstorelisten.html" title="STORE LISTEN"><span class="refentrytitle">STORE LISTEN</span></a> entries, and in modifying them if the
structure of the replication &#8220;<span class="quote">tree</span>&#8221;
changes.</p></li>
<li>
<p> Version 1.1 should provide better tools to help
manage this.</p>
<p> In fact, it does.  <a href="listenpaths.html#autolisten" title="8.3. Automated Listen Path Generation">Section 8.3, &#8220;Automated Listen Path Generation&#8221;</a> provides a
heuristic to generate listener entries.  If you are still tied to
earlier versions, a Perl script, <a href="altperl.html#regenlisten" title="18.25. regenerate-listens">Section 18.25, &#8220;regenerate-listens&#8221;</a>,
provides a way of querying a live <span class="productname">Slony-I</span> instance and generating the
<a href="slonik.html" title="slonik"><span class="refentrytitle"><a name="app-slonik-title"></a><span class="application">slonik</span></span></a> commands to generate the listen path
network.</p>
</li>
</ul></div>
<p>The issues of &#8220;<span class="quote">listener paths</span>&#8221; are discussed
further at <a href="listenpaths.html" title="8. Slony-I listen paths">Section 8, &#8220;<span class="productname">Slony-I</span> listen paths&#8221;</a> </p>
</td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="faq17"></a><a name="id2547921"></a><b>18.</b>
</td>
<td align="left" valign="top"><p>After dropping a node, <a href="table.sl-log-1.html">sl_log_1</a>
isn't getting purged out anymore.</p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"><b></b></td>
<td align="left" valign="top">
<p> This is a common scenario in versions before 1.0.5, as
the &#8220;<span class="quote">clean up</span>&#8221; that takes place when purging the node
does not include purging out old entries from the <span class="productname">Slony-I</span> table,
<a href="table.sl-confirm.html">sl_confirm</a>, for the recently departed
node.</p>
<p> The node is no longer around to update confirmations of what
syncs have been applied on it, and therefore the cleanup thread that
purges log entries thinks that it can't safely delete entries newer
than the final <a href="table.sl-confirm.html">sl_confirm</a> entry, which rather
curtails the ability to purge out old logs.</p>
<p>Diagnosis: Run the following query to see if there are any
&#8220;<span class="quote">phantom/obsolete/blocking</span>&#8221; <a href="table.sl-confirm.html">sl_confirm</a> entries:

</p>
<pre class="screen">oxrsbar=# select * from _oxrsbar.sl_confirm where con_origin not in (select no_id from _oxrsbar.sl_node) or con_received not in (select no_id from _oxrsbar.sl_node);
 con_origin | con_received | con_seqno |        con_timestamp                  
------------+--------------+-----------+----------------------------
          4 |          501 |     83999 | 2004-11-09 19:57:08.195969
          1 |            2 |   3345790 | 2004-11-14 10:33:43.850265
          2 |          501 |    102718 | 2004-11-14 10:33:47.702086
        501 |            2 |      6577 | 2004-11-14 10:34:45.717003
          4 |            5 |     83999 | 2004-11-14 21:11:11.111686
          4 |            3 |     83999 | 2004-11-24 16:32:39.020194
(6 rows)</pre>
<p>In version 1.0.5, the <a href="stmtdropnode.html" title="DROP NODE"><span class="refentrytitle">DROP NODE</span></a> function
purges out entries in <a href="table.sl-confirm.html">sl_confirm</a> for the
departing node.  In earlier versions, this needs to be done manually.
Supposing the node number is 3, then the query would be:

</p>
<pre class="screen">delete from _namespace.sl_confirm where con_origin = 3 or con_received = 3;</pre>
<p>Alternatively, to go after &#8220;<span class="quote">all phantoms,</span>&#8221; you could use
</p>
<pre class="screen">oxrsbar=# delete from _oxrsbar.sl_confirm where con_origin not in (select no_id from _oxrsbar.sl_node) or con_received not in (select no_id from _oxrsbar.sl_node);
DELETE 6</pre>
<p>General &#8220;<span class="quote">due diligence</span>&#8221; dictates starting with a
<tt class="command">BEGIN</tt>, looking at the contents of
<a href="table.sl-confirm.html">sl_confirm</a> before, ensuring that only the expected
records are purged, and then, only after that, confirming the change
with a <tt class="command">COMMIT</tt>.  If you delete confirm entries for
the wrong node, that could ruin your whole day.</p>
<p>You'll need to run this on each node that remains...</p>
<p>Note that as of 1.0.5, this is no longer an issue at all, as it
purges unneeded entries from <a href="table.sl-confirm.html">sl_confirm</a> in two
places:

</p>
<div class="itemizedlist"><ul type="disc">
<li><p> At the time a node is dropped</p></li>
<li><p> At the start of each
<tt class="function">cleanupEvent</tt> run, which is the event in which old
data is purged from <a href="table.sl-log-1.html">sl_log_1</a> and <a href="table.sl-seqlog.html">sl_seqlog</a></p></li>
</ul></div>
</td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="dupkey"></a><a name="id2548104"></a><b>19.</b>
</td>
<td align="left" valign="top">
<p>Replication Fails - Unique Constraint Violation</p>
<p>Replication has been running for a while, successfully, when a
node encounters a &#8220;<span class="quote">glitch,</span>&#8221; and replication logs are filled with
repetitions of the following:

</p>
<pre class="screen">DEBUG2 remoteWorkerThread_1: syncing set 2 with 5 table(s) from provider 1
DEBUG2 remoteWorkerThread_1: syncing set 1 with 41 table(s) from provider 1
DEBUG2 remoteWorkerThread_1: syncing set 5 with 1 table(s) from provider 1
DEBUG2 remoteWorkerThread_1: syncing set 3 with 1 table(s) from provider 1
DEBUG2 remoteHelperThread_1_1: 0.135 seconds delay for first row
DEBUG2 remoteHelperThread_1_1: 0.343 seconds until close cursor
ERROR  remoteWorkerThread_1: "insert into "_oxrsapp".sl_log_1          (log_origin, log_xid, log_tableid,                log_actionseq, log_cmdtype,		log_cmddata) values	  ('1', '919151224', '34', '35090538', 'D', '_rserv_ts=''9275244''');
delete from only public.epp_domain_host where _rserv_ts='9275244';insert into "_oxrsapp".sl_log_1	  (log_origin, log_xid, log_tableid,		log_actionseq, log_cmdtype,		log_cmddata) values	  ('1', '919151224', '34', '35090539', 'D', '_rserv_ts=''9275245''');
delete from only public.epp_domain_host where _rserv_ts='9275245';insert into "_oxrsapp".sl_log_1	  (log_origin, log_xid, log_tableid,		log_actionseq, log_cmdtype,		log_cmddata) values	  ('1', '919151224', '26', '35090540', 'D', '_rserv_ts=''24240590''');
delete from only public.epp_domain_contact where _rserv_ts='24240590';insert into "_oxrsapp".sl_log_1	  (log_origin, log_xid, log_tableid,		log_actionseq, log_cmdtype,		log_cmddata) values	  ('1', '919151224', '26', '35090541', 'D', '_rserv_ts=''24240591''');
delete from only public.epp_domain_contact where _rserv_ts='24240591';insert into "_oxrsapp".sl_log_1	  (log_origin, log_xid, log_tableid,		log_actionseq, log_cmdtype,		log_cmddata) values	  ('1', '919151224', '26', '35090542', 'D', '_rserv_ts=''24240589''');
delete from only public.epp_domain_contact where _rserv_ts='24240589';insert into "_oxrsapp".sl_log_1	  (log_origin, log_xid, log_tableid,		log_actionseq, log_cmdtype,		log_cmddata) values	  ('1', '919151224', '11', '35090543', 'D', '_rserv_ts=''36968002''');
delete from only public.epp_domain_status where _rserv_ts='36968002';insert into "_oxrsapp".sl_log_1	  (log_origin, log_xid, log_tableid,		log_actionseq, log_cmdtype,		log_cmddata) values	  ('1', '919151224', '11', '35090544', 'D', '_rserv_ts=''36968003''');
delete from only public.epp_domain_status where _rserv_ts='36968003';insert into "_oxrsapp".sl_log_1	  (log_origin, log_xid, log_tableid,		log_actionseq, log_cmdtype,		log_cmddata) values	  ('1', '919151224', '24', '35090549', 'I', '(contact_id,status,reason,_rserv_ts) values (''6972897'',''64'','''',''31044208'')');
insert into public.contact_status (contact_id,status,reason,_rserv_ts) values ('6972897','64','','31044208');insert into "_oxrsapp".sl_log_1	  (log_origin, log_xid, log_tableid,		log_actionseq, log_cmdtype,		log_cmddata) values	  ('1', '919151224', '24', '35090550', 'D', '_rserv_ts=''18139332''');
delete from only public.contact_status where _rserv_ts='18139332';insert into "_oxrsapp".sl_log_1	  (log_origin, log_xid, log_tableid,		log_actionseq, log_cmdtype,		log_cmddata) values	  ('1', '919151224', '24', '35090551', 'D', '_rserv_ts=''18139333''');
delete from only public.contact_status where _rserv_ts='18139333';" ERROR:  duplicate key violates unique constraint "contact_status_pkey"
 - qualification was: 
ERROR  remoteWorkerThread_1: SYNC aborted</pre>
<p>The transaction rolls back, and
<span class="productname">Slony-I</span> tries again, and again, and again.
The problem is with one of the <span class="emphasis"><em>last</em></span> SQL
statements, the one with <tt class="command">log_cmdtype = 'I'</tt>.  That
isn't quite obvious; what takes place is that
<span class="productname">Slony-I</span> groups 10 update queries together
to diminish the number of network round trips.</p>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"><b></b></td>
<td align="left" valign="top">
<p> A <span class="emphasis"><em>certain</em></span> cause for this has been
difficult to arrive at.</p>
<p>By the time we notice that there is a problem, the seemingly
missed delete transaction has been cleaned out of <a href="table.sl-log-1.html">sl_log_1</a>, so there appears to be no recovery
possible.  What has seemed necessary, at this point, is to drop the
replication set (or even the node), and restart replication from
scratch on that node.</p>
<p>In <span class="productname">Slony-I</span> 1.0.5, the handling of purges of <a href="table.sl-log-1.html">sl_log_1</a> became more conservative, refusing to purge
entries that haven't been successfully synced for at least 10 minutes
on all nodes.  It was not certain that that would prevent the
&#8220;<span class="quote">glitch</span>&#8221; from taking place, but it seemed plausible that
it might leave enough <a href="table.sl-log-1.html">sl_log_1</a> data to be able
to do something about recovering from the condition or at least
diagnosing it more exactly.  And perhaps the problem was that <a href="table.sl-log-1.html">sl_log_1</a> was being purged too aggressively, and this
would resolve the issue completely.</p>
<p> It is a shame to have to reconstruct a large replication node
for this; if you discover that this problem recurs, it may be an idea
to break replication down into multiple sets in order to diminish the
work involved in restarting replication.  If only one set has broken,
you may only need to unsubscribe/drop and resubscribe the one set.</p>
<p> In one case we found two lines in the SQL error message in the
log file that contained <span class="emphasis"><em> identical </em></span> insertions
into <a href="table.sl-log-1.html">sl_log_1</a>.  This <span class="emphasis"><em> ought</em></span> to be impossible as is a primary key on <a href="table.sl-log-1.html">sl_log_1</a>.  The latest (somewhat) punctured theory
that comes from <span class="emphasis"><em>that</em></span> was that perhaps this PK
index has been corrupted (representing a <span class="productname">PostgreSQL</span> bug), and that
perhaps the problem might be alleviated by running the query:</p>
<pre class="programlisting"># reindex table _slonyschema.sl_log_1;</pre>
<p> On at least one occasion, this has resolved the problem, so it
is worth trying this.</p>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"><b></b></td>
<td align="left" valign="top"><p> This problem has been found to represent a <span class="productname">PostgreSQL</span>
bug as opposed to one in <span class="productname">Slony-I</span>.  Version 7.4.8 was released with
two resolutions to race conditions that should resolve the issue.
Thus, if you are running a version of <span class="productname">PostgreSQL</span> earlier than 7.4.8,
you should consider upgrading to resolve this.</p></td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2548394"></a><a name="id2548396"></a><b>20.</b>
</td>
<td align="left" valign="top">
<p> If you have a <a href="slonik.html" title="slonik"><span class="refentrytitle"><a name="app-slonik-title"></a><span class="application">slonik</span></span></a> script
something like this, it will hang on you and never complete, because
you can't have <tt class="command">wait for event</tt> inside a
<tt class="command">try</tt> block. A <tt class="command">try</tt> block is
executed as one transaction, and the event that you are waiting for
can never arrive inside the scope of the transaction.</p>
<pre class="programlisting">try {
      echo 'Moving set 1 to node 3';
      lock set (id=1, origin=1);
      echo 'Set locked';
      wait for event (origin = 1, confirmed = 3);
      echo 'Moving set';
      move set (id=1, old origin=1, new origin=3);
      echo 'Set moved - waiting for event to be confirmed by node 3';
      wait for event (origin = 1, confirmed = 3);
      echo 'Confirmed';
} on error {
      echo 'Could not move set for cluster foo';
      unlock set (id=1, origin=1);
      exit -1;
}</pre>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"><b></b></td>
<td align="left" valign="top"><p> You must not invoke <a href="stmtwaitevent.html" title="WAIT FOR EVENT"><span class="refentrytitle">WAIT FOR EVENT</span></a>
inside a &#8220;<span class="quote">try</span>&#8221; block.</p></td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2548452"></a><a name="id2548454"></a><b>21.</b>
</td>
<td align="left" valign="top"><p> Is the ordering of tables in a set significant?</p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"><b></b></td>
<td align="left" valign="top"><p> Most of the time, it isn't.  You might imagine it of
some value to order the tables in some particular way in order that
&#8220;<span class="quote">parent</span>&#8221; entries would make it in before their &#8220;<span class="quote">children</span>&#8221;
in some foreign key relationship; that <span class="emphasis"><em>isn't</em></span> the case since
foreign key constraint triggers are turned off on subscriber nodes.</p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"><b></b></td>
<td align="left" valign="top"><p>(Jan Wieck comments:) The order of table ID's is only
significant during a <a href="stmtlockset.html" title="LOCK SET"><span class="refentrytitle">LOCK SET</span></a> in preparation of
switchover. If that order is different from the order in which an
application is acquiring its locks, it can lead to deadlocks that
abort either the application or <span class="application">slon</span>.</p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"><b></b></td>
<td align="left" valign="top"><p> (David Parker) I ran into one other case where the
ordering of tables in the set was significant: in the presence of
inherited tables. If a child table appears before its parent in a set,
then the initial subscription will end up deleting that child table
after it has possibly already received data, because the
<tt class="command">copy_set</tt> logic does a <tt class="command">delete</tt>,
not a <tt class="command">delete only</tt>, so the delete of the parent will
delete the new rows in the child as well.</p></td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2548523"></a><a name="id2548524"></a><b>22.</b>
</td>
<td align="left" valign="top"><p> What happens with rules and triggers on
<span class="productname">Slony-I</span>-replicated tables?</p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"><b></b></td>
<td align="left" valign="top">
<p> Firstly, let's look at how it is handled
<span class="emphasis"><em>absent</em></span> of the special handling of the <a href="stmtstoretrigger.html" title="STORE TRIGGER"><span class="refentrytitle">STORE TRIGGER</span></a> Slonik command.  </p>
<p> The function <a href="function.altertableforreplication-integer.html">schemadocaltertableforreplication( integer )</a> prepares each
table for replication.</p>
<div class="itemizedlist"><ul type="disc">
<li>
<p> On the origin node, this involves adding a trigger
that uses the <a href="function.logtrigger.html">schemadoclogtrigger(  )</a> function to the
table.</p>
<p> That trigger initiates the action of logging all updates to the
table to <span class="productname">Slony-I</span> <a href="table.sl-log-1.html">sl_log_1</a>
tables.</p>
</li>
<li>
<p> On a subscriber node, this involves disabling
triggers and rules, then adding in the trigger that denies write
access using the <tt class="function">denyAccess()</tt> function to
replicated tables.</p>
<p> Up until 1.1 (and perhaps onwards), the
&#8220;<span class="quote">disabling</span>&#8221; is done by modifying the
<tt class="envar">pg_trigger</tt> or <tt class="envar">pg_rewrite</tt>
<tt class="envar">tgrelid</tt> to point to the OID of the &#8220;<span class="quote">primary
key</span>&#8221; index on the table rather than to the table
itself.</p>
</li>
</ul></div>
<p> A somewhat unfortunate side-effect is that this handling of the
rules and triggers somewhat &#8220;<span class="quote">tramples</span>&#8221; on them.  The
rules and triggers are still there, but are no longer properly tied to
their tables.  If you do a <tt class="command">pg_dump</tt> on the
&#8220;<span class="quote">subscriber</span>&#8221; node, it won't find the rules and triggers
because it does not expect them to be associated with an index.</p>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"><b></b></td>
<td align="left" valign="top">
<p> Now, consider how <a href="stmtstoretrigger.html" title="STORE TRIGGER"><span class="refentrytitle">STORE TRIGGER</span></a>
enters into things.</p>
<p> Simply put, this command causes
<span class="productname">Slony-I</span> to restore the trigger using
<tt class="function">alterTableRestore(table id)</tt>, which restores the
table's OID into the <tt class="envar">pg_trigger</tt> or
<tt class="envar">pg_rewrite</tt> <tt class="envar">tgrelid</tt> column on the
affected node.</p>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"><b></b></td>
<td align="left" valign="top">
<p> This implies that if you plan to draw backups from a
subscriber node, you will need to draw the schema from the origin
node.  It is straightforward to do this: </p>
<pre class="screen">% pg_dump -h originnode.example.info -p 5432 --schema-only --schema=public ourdb &gt; schema_backup.sql
% pg_dump -h subscribernode.example.info -p 5432 --data-only --schema=public ourdb &gt; data_backup.sql</pre>
</td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2548700"></a><a name="id2548701"></a><b>23.</b>
</td>
<td align="left" valign="top">
<p> After notification of a subscription on
<span class="emphasis"><em>another</em></span> node, replication falls over, starting
with the following error message:</p>
<pre class="screen">ERROR  remoteWorkerThread_1: "begin transaction; set transaction isolation level serializable; lock table "_livesystem".sl_config_lock; select "_livesystem".enableSubscription(25506, 1, 501); notify "_livesystem_Event"; notify "_livesystem_Confirm"; insert into "_livesystem".sl_event     (ev_origin, ev_seqno, ev_timestamp,      ev_minxid, ev_maxxid, ev_xip, ev_type , ev_data1, ev_data2, ev_data3, ev_data4    ) values ('1', '4896546', '2005-01-23 16:08:55.037395', '1745281261', '1745281262', '', 'ENABLE_SUBSCRIPTION', '25506', '1', '501', 't'); insert into "_livesystem".sl_confirm      (con_origin, con_received, con_seqno, con_timestamp)    values (1, 4, '4896546', CURRENT_TIMESTAMP); commit transaction;" PGRES_FATAL_ERROR ERROR:  insert or update on table "sl_subscribe" violates foreign key constraint "sl_subscribe-sl_path-ref"
DETAIL:  Key (sub_provider,sub_receiver)=(1,501) is not present in table "sl_path".</pre>
<p> This is then followed by a series of failed syncs as the <a href="slon.html" title="slon"><span class="refentrytitle"><a name="app-slon-title"></a><span class="application">slon</span></span></a> shuts down:

</p>
<pre class="screen">DEBUG2 remoteListenThread_1: queue event 1,4897517 SYNC
DEBUG2 remoteListenThread_1: queue event 1,4897518 SYNC
DEBUG2 remoteListenThread_1: queue event 1,4897519 SYNC
DEBUG2 remoteListenThread_1: queue event 1,4897520 SYNC
DEBUG2 remoteWorker_event: ignore new events due to shutdown
DEBUG2 remoteListenThread_1: queue event 1,4897521 SYNC
DEBUG2 remoteWorker_event: ignore new events due to shutdown
DEBUG2 remoteListenThread_1: queue event 1,4897522 SYNC
DEBUG2 remoteWorker_event: ignore new events due to shutdown
DEBUG2 remoteListenThread_1: queue event 1,4897523 SYNC</pre>
<p>
</p>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"><b></b></td>
<td align="left" valign="top"><p> If you see a <a href="slon.html" title="slon"><span class="refentrytitle"><a name="app-slon-title"></a><span class="application">slon</span></span></a> shutting down with
<span class="emphasis"><em>ignore new events due to shutdown</em></span> log entries,
you'll typically have to step back to <span class="emphasis"><em>before</em></span> they
started failing to see indication of the root cause of the problem.
</p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"><b></b></td>
<td align="left" valign="top">
<p> In this particular case, the problem was that some of
the <a href="stmtstorepath.html" title="STORE
     PATH"><span class="refentrytitle">STORE
     PATH</span></a> commands had not yet made it to
node 4 before the <a href="stmtsubscribeset.html" title="SUBSCRIBE SET"><span class="refentrytitle">SUBSCRIBE SET</span></a> command
propagated. </p>
<p>This is yet another example of the need to not do things too
terribly quickly; you need to be sure things are working right
<span class="emphasis"><em>before</em></span> making further configuration changes.</p>
</td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2548800"></a><a name="id2548801"></a><b>24.</b>
</td>
<td align="left" valign="top"><p>I just used <a href="stmtmoveset.html" title="MOVE SET"><span class="refentrytitle">MOVE SET</span></a> to move the
origin to a new node.  Unfortunately, some subscribers are still
pointing to the former origin node, so I can't take it out of service
for maintenance without stopping them from getting updates.  What do I
do?  </p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"><b></b></td>
<td align="left" valign="top">
<p> You need to use <a href="stmtsubscribeset.html" title="SUBSCRIBE SET"><span class="refentrytitle">SUBSCRIBE SET</span></a> to
alter the subscriptions for those nodes to have them subscribe to a
provider that <span class="emphasis"><em>will</em></span> be sticking around during the
maintenance.</p>
<div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;">
<h3 class="title">Warning</h3>
<p> What you <span class="emphasis"><em>don't</em></span> do is to <a href="stmtunsubscribeset.html" title="UNSUBSCRIBE SET"><span class="refentrytitle">UNSUBSCRIBE SET</span></a>; that would require reloading all data
for the nodes from scratch later.
</p>
</div>
</td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="longtxnsareevil"></a><a name="id2548848"></a><b>25.</b>
</td>
<td align="left" valign="top"><p> Replication has been slowing down, I'm seeing
<tt class="command"> FETCH 100 FROM LOG </tt> queries running for a long
time, <a href="table.sl-log-1.html">sl_log_1</a> is growing, and performance is,
well, generally getting steadily worse. </p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"><b></b></td>
<td align="left" valign="top">
<p> There are actually a number of possible causes for
this sort of thing.  There is a question involving similar pathology
where the problem is that <a href="faq.html#pglistenerfull"> <tt class="envar">pg_listener </tt> grows because it is not vacuumed. </a></p>
<p> Another &#8220;<span class="quote"> proximate cause </span>&#8221; for this growth is for
there to be a connection connected to the node that sits <tt class="command">IDLE IN TRANSACTION </tt> for a very long time. </p>
<p> That open transaction will have multiple negative effects, all
of which will adversely affect performance:</p>
<div class="itemizedlist"><ul type="disc">
<li><p> Vacuums on all tables, including <tt class="envar"> pg_listener</tt>, will not clear out dead tuples from before the start of the
idle transaction. </p></li>
<li><p> The cleanup thread will be unable to clean out
entries in <a href="table.sl-log-1.html">sl_log_1</a> and <a href="table.sl-seqlog.html">sl_seqlog</a>, with the result that these tables will
grow, ceaselessly, until the transaction is closed. </p></li>
</ul></div>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"><b></b></td>
<td align="left" valign="top"><p> You can monitor for this condition inside the database
only if the <span class="productname"> PostgreSQL </span> <tt class="filename">postgresql.conf </tt> parameter
<tt class="envar">stats_command_string</tt> is set to true.  If that is set,
then you may submit the query <tt class="command"> select * from pg_stat_activity
where current_query like '%IDLE% in transaction'; </tt> which
will find relevant activity.</p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"><b></b></td>
<td align="left" valign="top"><p> You should also be able to search for &#8220;<span class="quote"> idle in
transaction </span>&#8221; in the process table to find processes that are
thus holding on to an ancient transaction.  </p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"><b></b></td>
<td align="left" valign="top"><p> It is also possible (though rarer) for the problem to
be a transaction that is, for some other reason, being held open for a
very long time.  The <tt class="envar"> query_start </tt> time in <tt class="envar">pg_stat_activity </tt> may show you some query that has been
running way too long.  </p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"><b></b></td>
<td align="left" valign="top"><p> There are plans for <span class="productname"> PostgreSQL</span> to have a timeout parameter, <tt class="envar">open_idle_transaction_timeout </tt>, which would cause old
transactions to time out after some period of disuse.  Buggy
connection pool logic is a common culprit for this sort of thing.
There are plans for <span class="productname"> <a href="help.html#pgpool"> pgpool</a> </span> to provide a better alternative, eventually,
where connections would be shared inside a connection pool implemented
in C.  You may have some more or less buggy connection pool in your
Java or PHP application; if a small set of <span class="emphasis"><em> real </em></span>
connections are held in <span class="productname">pgpool</span>, that will
hide from the database the fact that the application imagines that
numerous of them are left idle in transaction for hours at a time.</p></td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="neededexecddl"></a><a name="id2549029"></a><b>26.</b>
</td>
<td align="left" valign="top">
<p> Behaviour - all the subscriber nodes start to fall
behind the origin, and all the logs on the subscriber nodes have the
following error message repeating in them (when I encountered it,
there was a nice long SQL statement above each entry):</p>
<pre class="screen">ERROR remoteWorkerThread_1: helper 1 finished with error
ERROR remoteWorkerThread_1: SYNC aborted</pre>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"><b></b></td>
<td align="left" valign="top">
<p> Cause: you have likely issued <tt class="command">alter
table</tt> statements directly on the databases instead of using
the slonik <a href="stmtddlscript.html" title="EXECUTE SCRIPT"><span class="refentrytitle">EXECUTE SCRIPT</span></a> command.</p>
<p>The solution is to rebuild the trigger on the affected table and
fix the entries in <a href="table.sl-log-1.html">sl_log_1</a> by hand.</p>
<div class="itemizedlist"><ul type="disc">
<li><p> You'll need to identify from either the slon logs, or
the PostgreSQL database logs exactly which statement it is that is
causing the error.</p></li>
<li>
<p> You need to fix the Slony-defined triggers on the
table in question.  This is done with the following procedure.</p>
<pre class="screen">BEGIN;
LOCK TABLE table_name;
SELECT _oxrsorg.altertablerestore(tab_id);--tab_id is _slony_schema.sl_table.tab_id
SELECT _oxrsorg.altertableforreplication(tab_id);--tab_id is _slony_schema.sl_table.tab_id
COMMIT;</pre>
<p>You then need to find the rows in <a href="table.sl-log-1.html">sl_log_1</a> that have bad 
entries and fix them.  You may
want to take down the slon daemons for all nodes except the master;
that way, if you make a mistake, it won't immediately propagate
through to the subscribers.</p>
<p> Here is an example:</p>
<pre class="screen">BEGIN;

LOCK TABLE customer_account;

SELECT _app1.altertablerestore(31);
SELECT _app1.altertableforreplication(31);
COMMIT;

BEGIN;
LOCK TABLE txn_log;

SELECT _app1.altertablerestore(41);
SELECT _app1.altertableforreplication(41);

COMMIT;

--fixing customer_account, which had an attempt to insert a "" into a timestamp with timezone.
BEGIN;

update _app1.sl_log_1 SET log_cmddata = 'balance=''60684.00'' where pkey=''49''' where log_actionseq = '67796036';
update _app1.sl_log_1 SET log_cmddata = 'balance=''60690.00'' where pkey=''49''' where log_actionseq = '67796194';
update _app1.sl_log_1 SET log_cmddata = 'balance=''60684.00'' where pkey=''49''' where log_actionseq = '67795881';
update _app1.sl_log_1 SET log_cmddata = 'balance=''1852.00'' where pkey=''57''' where log_actionseq = '67796403';
update _app1.sl_log_1 SET log_cmddata = 'balance=''87906.00'' where pkey=''8''' where log_actionseq = '68352967';
update _app1.sl_log_1 SET log_cmddata = 'balance=''125180.00'' where pkey=''60''' where log_actionseq = '68386951';
update _app1.sl_log_1 SET log_cmddata = 'balance=''125198.00'' where pkey=''60''' where log_actionseq = '68387055';
update _app1.sl_log_1 SET log_cmddata = 'balance=''125174.00'' where pkey=''60''' where log_actionseq = '68386682';
update _app1.sl_log_1 SET log_cmddata = 'balance=''125186.00'' where pkey=''60''' where log_actionseq = '68386992';
update _app1.sl_log_1 SET log_cmddata = 'balance=''125192.00'' where pkey=''60''' where log_actionseq = '68387029';
</pre>
</li>
</ul></div>
</td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2549133"></a><a name="id2549134"></a><b>27.</b>
</td>
<td align="left" valign="top">
<p> After notification of a subscription on
<span class="emphasis"><em>another</em></span> node, replication falls over on one of
the subscribers, with the following error message:</p>
<pre class="screen">ERROR  remoteWorkerThread_1: "begin transaction; set transaction isolation level serializable; lock table "_livesystem".sl_config_lock; select "_livesystem".enableSubscription(25506, 1, 501); notify "_livesystem_Event"; notify "_livesystem_Confirm"; insert into "_livesystem".sl_event     (ev_origin, ev_seqno, ev_timestamp,      ev_minxid, ev_maxxid, ev_xip, ev_type , ev_data1, ev_data2, ev_data3, ev_data4    ) values ('1', '4896546', '2005-01-23 16:08:55.037395', '1745281261', '1745281262', '', 'ENABLE_SUBSCRIPTION', '25506', '1', '501', 't'); insert into "_livesystem".sl_confirm      (con_origin, con_received, con_seqno, con_timestamp)    values (1, 4, '4896546', CURRENT_TIMESTAMP); commit transaction;" PGRES_FATAL_ERROR ERROR:  insert or update on table "sl_subscribe" violates foreign key constraint "sl_subscribe-sl_path-ref"
DETAIL:  Key (sub_provider,sub_receiver)=(1,501) is not present in table "sl_path".</pre>
<p> This is then followed by a series of failed syncs as the <a href="slon.html" title="slon"><span class="refentrytitle"><a name="app-slon-title"></a><span class="application">slon</span></span></a> shuts down:</p>
<pre class="screen">DEBUG2 remoteListenThread_1: queue event 1,4897517 SYNC
DEBUG2 remoteListenThread_1: queue event 1,4897518 SYNC
DEBUG2 remoteListenThread_1: queue event 1,4897519 SYNC
DEBUG2 remoteListenThread_1: queue event 1,4897520 SYNC
DEBUG2 remoteWorker_event: ignore new events due to shutdown
DEBUG2 remoteListenThread_1: queue event 1,4897521 SYNC
DEBUG2 remoteWorker_event: ignore new events due to shutdown
DEBUG2 remoteListenThread_1: queue event 1,4897522 SYNC
DEBUG2 remoteWorker_event: ignore new events due to shutdown
DEBUG2 remoteListenThread_1: queue event 1,4897523 SYNC</pre>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"><b></b></td>
<td align="left" valign="top"><p> If you see a <a href="slon.html" title="slon"><span class="refentrytitle"><a name="app-slon-title"></a><span class="application">slon</span></span></a> shutting down with
<span class="emphasis"><em>ignore new events due to shutdown</em></span> log entries,
you typically need to step back in the log to
<span class="emphasis"><em>before</em></span> they started failing to see indication of
the root cause of the problem.  </p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"><b></b></td>
<td align="left" valign="top">
<p> In this particular case, the problem was that some of
the <a href="stmtstorepath.html" title="STORE
     PATH"><span class="refentrytitle">STORE
     PATH</span></a> commands had not yet made it to
node 4 before the <a href="stmtsubscribeset.html" title="SUBSCRIBE SET"><span class="refentrytitle">SUBSCRIBE SET</span></a> command
propagated. </p>
<p>This demonstrates yet another example of the need to not do
things in a rush; you need to be sure things are working right
<span class="emphasis"><em>before</em></span> making further configuration changes.</p>
</td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2549232"></a><a name="id2549233"></a><b>28.</b>
</td>
<td align="left" valign="top"><p> I can do a <tt class="command">pg_dump</tt>
and load the data back in much faster than the <tt class="command">SUBSCRIBE
SET</tt> runs.  Why is that?  </p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"><b></b></td>
<td align="left" valign="top">
<p> <span class="productname">Slony-I</span> depends on there
being an already existant index on the primary key, and leaves all
indexes alone whilst using the <span class="productname">PostgreSQL</span>
<tt class="command">COPY</tt> command to load the data.  Further hurting
performane, the <tt class="command">COPY SET</tt> event starts by deleting
the contents of tables, which potentially leaves a lot of dead tuples</p>
<p> When you use <tt class="command">pg_dump</tt> to dump the contents of
a database, and then load that, creation of indexes is deferred until
the very end.  It is <span class="emphasis"><em>much</em></span> more efficient to
create indexes against the entire table, at the end, than it is to
build up the index incrementally as each row is added to the
table.</p>
<p> Unfortunately, dropping and recreating indexes &#8220;<span class="quote">on the
fly,</span>&#8221; as it were, has proven thorny.  Doing it automatically
hasn't been implemented.  </p>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"><b></b></td>
<td align="left" valign="top"><p> If you can drop unnecessary indices while the
<tt class="command">COPY</tt> takes place, that will improve performance
quite a bit.  If you can <tt class="command">TRUNCATE</tt> tables that
contain data that is about to be eliminated, that will improve
performance <span class="emphasis"><em>a lot.</em></span> </p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"><b></b></td>
<td align="left" valign="top"><p> There is a TODO item for implementation in
<span class="productname">PostgreSQL</span> that adds a new option,
something like <tt class="option">BULKLOAD</tt>, which would defer revising
indexes until the end, and regenerating indexes in bulk.  That will
likely not be available until <span class="productname">PostgreSQL</span>
8.1, but it should substantially improve performance once available.</p></td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2549350"></a><a name="id2549352"></a><b>29.</b>
</td>
<td align="left" valign="top"><p> I had a network &#8220;<span class="quote">glitch</span>&#8221; that led to my
using <a href="stmtfailover.html" title="FAILOVER"><span class="refentrytitle">FAILOVER</span></a> to fail over to an alternate node.
The failure wasn't a disk problem that would corrupt databases; why do
I need to rebuild the failed node from scratch? </p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"><b></b></td>
<td align="left" valign="top"><p> The action of <a href="stmtfailover.html" title="FAILOVER"><span class="refentrytitle">FAILOVER</span></a> is to
<span class="emphasis"><em>abandon</em></span> the failed node so that no more <span class="productname">Slony-I</span>
activity goes to or from that node.  As soon as that takes place, the
failed node will progressively fall further and further out of sync.</p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"><b></b></td>
<td align="left" valign="top"><p> The <span class="emphasis"><em>big</em></span> problem with trying to
recover the failed node is that it may contain updates that never made
it out of the origin.  If they get retried, on the new origin, you may
find that you have conflicting updates.  In any case, you do have a
sort of &#8220;<span class="quote">logical</span>&#8221; corruption of the data even if there
never was a disk failure making it &#8220;<span class="quote">physical.</span>&#8221;</p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"><b></b></td>
<td align="left" valign="top"><p> As discusssed in <a href="failover.html" title="7. Doing switchover and failover with Slony-I">Section 7, &#8220;Doing switchover and failover with <span class="productname">Slony-I</span>&#8221;</a>, using <a href="stmtfailover.html" title="FAILOVER"><span class="refentrytitle">FAILOVER</span></a> should be considered a <span class="emphasis"><em>last
resort</em></span> as it implies that you are abandoning the origin
node as being corrupted.  </p></td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="morethansuper"></a><a name="id2549433"></a><b>30.</b>
</td>
<td align="left" valign="top">
<p> I created a &#8220;<span class="quote">superuser</span>&#8221; account,
<tt class="command">slony</tt>, to run replication activities.  As
suggested, I set it up as a superuser, via the following query: 
<tt class="command">update pg_shadow set usesuper = 't' where usename in ('slony',
'molly', 'dumpy');</tt>
(that command also deals with other users I set up to run vacuums and
backups).</p>
<p> Unfortunately, I ran into a problem the next time I subscribed
to a new set.</p>
<pre class="programlisting">DEBUG1 copy_set 28661
DEBUG1 remoteWorkerThread_1: connected to provider DB
DEBUG2 remoteWorkerThread_78: forward confirm 1,594436 received by 78
DEBUG2 remoteWorkerThread_1: copy table public.billing_discount
ERROR  remoteWorkerThread_1: "select "_mycluster".setAddTable_int(28661, 51, 'public.billing_discount', 'billing_discount_pkey', 'Table public.billing_discount with candidate primary key billing_discount_pkey'); " PGRES_FATAL_ERROR ERROR:  permission denied for relation pg_class
CONTEXT:  PL/pgSQL function "altertableforreplication" line 23 at select into variables
PL/pgSQL function "setaddtable_int" line 76 at perform
WARN   remoteWorkerThread_1: data copy for set 28661 failed - sleep 60 seconds</pre>
<p> This continues to fail, over and over, until I restarted the
<span class="application">slon</span> to connect as
<tt class="command">postgres</tt> instead.</p>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"><b></b></td>
<td align="left" valign="top"><p> The problem is fairly self-evident; permission is being
denied on the system table, <tt class="envar">pg_class</tt>.</p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"><b></b></td>
<td align="left" valign="top">
<p> The &#8220;<span class="quote">fix</span>&#8221; is thus:</p>
<pre class="programlisting">update pg_shadow set usesuper = 't', usecatupd='t' where usename = 'slony';</pre>
</td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="missingoids"></a><a name="id2549517"></a><b>31.</b>
</td>
<td align="left" valign="top">
<p> We got bitten by
something we didn't foresee when completely uninstalling a slony
replication cluster from the master and slave...</p>
<div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;">
<h3 class="title">Warning</h3>
<p><span class="emphasis"><em>MAKE SURE YOU STOP YOUR APPLICATION RUNNING
AGAINST YOUR MASTER DATABASE WHEN REMOVING THE WHOLE SLONY
CLUSTER</em></span>, or at least re-cycle all your open connections
after the event!  </p>
</div>
<p> The connections &#8220;<span class="quote">remember</span>&#8221; or refer to OIDs which
are removed by the uninstall node script. And you get lots of errors
as a result...</p>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"><b></b></td>
<td align="left" valign="top">
<p> There are two notable areas of
<span class="productname">PostgreSQL</span> that cache query plans and OIDs:</p>
<div class="itemizedlist"><ul type="disc">
<li><p> Prepared statements</p></li>
<li><p> pl/pgSQL functions</p></li>
</ul></div>
<p> The problem isn't particularly a <span class="productname">Slony-I</span> one; it would occur
any time such significant changes are made to the database schema.  It
shouldn't be expected to lead to data loss, but you'll see a wide
range of OID-related errors.</p>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"><b></b></td>
<td align="left" valign="top"><p> The problem occurs when you are using some sort of
&#8220;<span class="quote">connection pool</span>&#8221; that keeps recycling old connections.
If you restart the application after this, the new connections will
create <span class="emphasis"><em>new</em></span> query plans, and the errors will go
away.  If your connection pool drops the connections, and creates new
ones, the new ones will have <span class="emphasis"><em>new</em></span> query plans, and
the errors will go away. </p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"><b></b></td>
<td align="left" valign="top"><p> In our code we drop the connection on any error we
cannot map to an expected condition. This would eventually recycle all
connections on such unexpected problems after just one error per
connection.  Of course if the error surfaces as a constraint violation
which is a recognized condition, this won't help either, and if the
problem is persistent, the connections will keep recycling which will
drop the effect of the pooling, in the latter case the pooling code
could also announce an admin to take a look...  </p></td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2549601"></a><a name="id2549602"></a><b>32.</b>
</td>
<td align="left" valign="top">
<p> Node #1 was dropped via <a href="stmtdropnode.html" title="DROP NODE"><span class="refentrytitle">DROP NODE</span></a>, and the <a href="slon.html" title="slon"><span class="refentrytitle"><a name="app-slon-title"></a><span class="application">slon</span></span></a> one of the
other nodes is repeatedly failing with the error message:</p>
<pre class="screen">ERROR  remoteWorkerThread_3: "begin transaction; set transaction isolation level
 serializable; lock table "_mailermailer".sl_config_lock; select "_mailermailer"
.storeListen_int(2, 1, 3); notify "_mailermailer_Event"; notify "_mailermailer_C
onfirm"; insert into "_mailermailer".sl_event     (ev_origin, ev_seqno, ev_times
tamp,      ev_minxid, ev_maxxid, ev_xip, ev_type , ev_data1, ev_data2, ev_data3
   ) values ('3', '2215', '2005-02-18 10:30:42.529048', '3286814', '3286815', ''
, 'STORE_LISTEN', '2', '1', '3'); insert into "_mailermailer".sl_confirm
(con_origin, con_received, con_seqno, con_timestamp)    values (3, 2, '2215', CU
RRENT_TIMESTAMP); commit transaction;" PGRES_FATAL_ERROR ERROR:  insert or updat
e on table "sl_listen" violates foreign key constraint "sl_listen-sl_path-ref"
DETAIL:  Key (li_provider,li_receiver)=(1,3) is not present in table "sl_path".
DEBUG1 syncThread: thread done</pre>
<p> Evidently, a <a href="stmtstorelisten.html" title="STORE LISTEN"><span class="refentrytitle">STORE LISTEN</span></a> request hadn't
propagated yet before node 1 was dropped.  </p>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top">
<a name="eventsurgery"></a><b></b>
</td>
<td align="left" valign="top">
<p> This points to a case where you'll
need to do &#8220;<span class="quote">event surgery</span>&#8221; on one or more of the nodes.
A <tt class="command">STORE_LISTEN</tt> event remains outstanding that wants
to add a listen path that <span class="emphasis"><em>cannot</em></span> be created
because node 1 and all paths pointing to node 1 have gone away.</p>
<p> Let's assume, for exposition purposes, that the remaining nodes
are #2 and #3, and that the above error is being reported on node
#3.</p>
<p> That implies that the event is stored on node #2, as it
wouldn't be on node #3 if it had not already been processed
successfully.  The easiest way to cope with this situation is to
delete the offending <a href="table.sl-event.html">sl_event</a> entry on node #2.
You'll connect to node #2's database, and search for the
<tt class="command">STORE_LISTEN</tt> event:</p>
<p> <tt class="command"> select * from sl_event where ev_type =
'STORE_LISTEN';</tt></p>
<p> There may be several entries, only some of which need to be
purged. </p>
<pre class="screen"> 
-# begin;  -- Don't straight delete them; open a transaction so you can respond to OOPS
BEGIN;
-# delete from sl_event where ev_type = 'STORE_LISTEN' and
-#  (ev_data1 = '1' or ev_data2 = '1' or ev_data3 = '1');
DELETE 3
-# -- Seems OK...
-# commit;
COMMIT</pre>
<p> The next time the <span class="application">slon</span> for node 3
starts up, it will no longer find the &#8220;<span class="quote">offensive</span>&#8221;
<tt class="command">STORE_LISTEN</tt> events, and replication can continue.
(You may then run into some other problem where an old stored event is
referring to no-longer-existant configuration...) </p>
</td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2549736"></a><a name="id2549737"></a><b>33.</b>
</td>
<td align="left" valign="top"><p> I am using <span class="productname"> Frotznik Freenix
4.5</span>, with its <span class="acronym">FFPM</span> (Frotznik Freenix
Package Manager) package management system.  It comes with
<span class="acronym">FFPM</span> packages for <span class="productname">PostgreSQL</span> 7.4.7, which are what
I am using for my databases, but they don't include <span class="productname">Slony-I</span> in the
packaging.  How do I add <span class="productname">Slony-I</span> to this?  </p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"><b></b></td>
<td align="left" valign="top">
<p> <span class="productname">Frotznik Freenix</span> is new to
me, so it's a bit dangerous to give really hard-and-fast definitive
answers.  </p>
<p> The answers differ somewhat between the various combinations of
<span class="productname">PostgreSQL</span> and <span class="productname">Slony-I</span> versions; the newer versions generally
somewhat easier to cope with than are the older versions.  In general,
you almost certainly need to compile <span class="productname">Slony-I</span> from sources; depending
on versioning of both <span class="productname">Slony-I</span> and <span class="productname">PostgreSQL</span>, you
<span class="emphasis"><em>may</em></span> need to compile <span class="productname">PostgreSQL</span> from scratch.
(Whether you need to <span class="emphasis"><em> use </em></span> the <span class="productname">PostgreSQL</span> compile
is another matter; you probably don't...) </p>
<div class="itemizedlist"><ul type="disc">
<li>
<p> <span class="productname">Slony-I</span> version 1.0.5 and earlier require having a
fully configured copy of <span class="productname">PostgreSQL</span> sources available when you compile
<span class="productname">Slony-I</span>.</p>
<p> <span class="emphasis"><em>Hopefully</em></span> you can make the configuration
this closely match against the configuration in use by the packaged
version of <span class="productname">PostgreSQL</span> by checking the configuration using the command
<tt class="command"> pg_config --configure</tt>. </p>
</li>
<li><p> <span class="productname">Slony-I</span> version 1.1 simplifies this considerably;
it does not require the full copy of <span class="productname">PostgreSQL</span> sources, but can,
instead, refer to the various locations where <span class="productname">PostgreSQL</span> libraries,
binaries, configuration, and <tt class="command"> #include </tt> files are
located.  </p></li>
<li>
<p> <span class="productname">PostgreSQL</span> 8.0 and higher is generally easier to deal
with in that a &#8220;<span class="quote">default</span>&#8221; installation includes all of the
<tt class="command"> #include </tt> files.  </p>
<p> If you are using an earlier version of <span class="productname">PostgreSQL</span>, you may find
it necessary to resort to a source installation if the packaged
version did not install the &#8220;<span class="quote">server
<tt class="command">#include</tt></span>&#8221; files, which are installed by the
command <tt class="command"> make install-all-headers </tt>.</p>
</li>
</ul></div>
<p> In effect, the &#8220;<span class="quote">worst case</span>&#8221; scenario takes place
if you are using a version of <span class="productname">Slony-I</span> earlier than 1.1 with an
&#8220;<span class="quote">elderly</span>&#8221; version of <span class="productname">PostgreSQL</span>, in which case you can
expect to need to compile <span class="productname">PostgreSQL</span> from scratch in order to have
everything that the <span class="productname">Slony-I</span> compile needs even though you are using a
&#8220;<span class="quote">packaged</span>&#8221; version of <span class="productname">PostgreSQL</span>.</p>
<p> If you are running a recent <span class="productname">PostgreSQL</span> and a recent <span class="productname">Slony-I</span>,
then the codependencies can be fairly small, and you may not need
extra <span class="productname">PostgreSQL</span> sources.  These improvements should ease the
production of <span class="productname">Slony-I</span> packages so that you might soon even be able to
hope to avoid compiling <span class="productname">Slony-I</span>.</p>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"><b></b></td>
<td align="left" valign="top"><p> </p></td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="sequenceset"></a><a name="id2550052"></a><b>34.</b>
</td>
<td align="left" valign="top"><p> <a href="http://gborg.postgresql.org/project/slony1/bugs/bugupdate.php?1226" target="_top">Bug #1226 </a> indicates an error condition that can come up if
you have a replication set that consists solely of sequences. </p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"><b></b></td>
<td align="left" valign="top"><p> The  short answer is that having a replication set
consisting only of sequences is not a <a href="bestpractices.html" title="20.  Slony-I &#8220;Best Practices&#8221; ">best practice.</a> </p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"><b></b></td>
<td align="left" valign="top">
<p> The problem with a sequence-only set comes up only if you have
a case where the only subscriptions that are active for a particular
subscriber to a particular provider are for
&#8220;<span class="quote">sequence-only</span>&#8221; sets.  If a node gets into that state,
replication will fail, as the query that looks for data from <a href="table.sl-log-1.html">sl_log_1</a> has no tables to find, and the query will be
malformed, and fail.  If a replication set <span class="emphasis"><em>with</em></span>
tables is added back to the mix, everything will work out fine; it
just <span class="emphasis"><em>seems</em></span> scary.</p>
<p> This problem should be resolved some time after <span class="productname">Slony-I</span>
1.1.0.</p>
</td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2550114"></a><a name="id2550115"></a><b>35.</b>
</td>
<td align="left" valign="top">
<p> I tried the following query which did not work:</p>
<pre class="programlisting">sdb=# explain select query_start, current_query from pg_locks join
pg_stat_activity on pid = procpid where granted = true and transaction
in (select transaction from pg_locks where granted = false); 

ERROR: could not find hash function for hash operator 716373</pre>
<p> It appears the <span class="productname">Slony-I</span> <tt class="function">xxid</tt> functions are
claiming to be capable of hashing, but cannot actually do so.</p>
<p> What's up? </p>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"><b></b></td>
<td align="left" valign="top">
<p> <span class="productname">Slony-I</span> defined an XXID data type and operators on
that type in order to allow manipulation of transaction IDs that are
used to group together updates that are associated with the same
transaction.</p>
<p> Operators were not available for <span class="productname">PostgreSQL</span> 7.3 and earlier
versions; in order to support version 7.3, custom functions had to be
added.  The <tt class="function">=</tt> operator was marked as supporting
hashing, but for that to work properly, the join operator must appear
in a hash index operator class.  That was not defined, and as a
result, queries (like the one above) that decide to use hash joins
will fail. </p>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"><b></b></td>
<td align="left" valign="top"><p> This has <span class="emphasis"><em> not </em></span> been considered a
&#8220;<span class="quote">release-critical</span>&#8221; bug, as <span class="productname">Slony-I</span> does not internally
generate queries likely to use hash joins.  This problem shouldn't
injure <span class="productname">Slony-I</span>'s ability to continue replicating. </p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"><b></b></td>
<td align="left" valign="top"><p> Future releases of <span class="productname">Slony-I</span> (<span class="emphasis"><em>e.g.</em></span>
1.0.6, 1.1) will omit the <tt class="command">HASHES</tt> indicator, so that</p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"><b></b></td>
<td align="left" valign="top">
<p> Supposing you wish to repair an existing instance, so
that your own queries will not run afoul of this problem, you may do
so as follows: </p>
<pre class="programlisting">/* cbbrowne@[local]/dba2 slony_test1=*/ \x     
Expanded display is on.
/* cbbrowne@[local]/dba2 slony_test1=*/ select * from pg_operator where oprname = '=' 
and oprnamespace = (select oid from pg_namespace where nspname = 'public');
-[ RECORD 1 ]+-------------
oprname      | =
oprnamespace | 2200
oprowner     | 1
oprkind      | b
oprcanhash   | t
oprleft      | 82122344
oprright     | 82122344
oprresult    | 16
oprcom       | 82122365
oprnegate    | 82122363
oprlsortop   | 82122362
oprrsortop   | 82122362
oprltcmpop   | 82122362
oprgtcmpop   | 82122360
oprcode      | "_T1".xxideq
oprrest      | eqsel
oprjoin      | eqjoinsel

/* cbbrowne@[local]/dba2 slony_test1=*/ update pg_operator set oprcanhash = 'f' where 
oprname = '=' and oprnamespace = 2200 ;
UPDATE 1</pre>
</td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="v72upgrade"></a><a name="id2550263"></a><b>36.</b>
</td>
<td align="left" valign="top"><p> I have a <span class="productname">PostgreSQL</span> 7.2-based system that I
<span class="emphasis"><em>really, really</em></span> want to use <span class="productname">Slony-I</span> to help me
upgrade it to 8.0.  What is involved in getting <span class="productname">Slony-I</span> to work for
that?</p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"><b></b></td>
<td align="left" valign="top">
<p> Rod Taylor has reported the following...</p>
<p> This is approximately what you need to do:</p>
<div class="itemizedlist"><ul type="disc">
<li><p>Take the 7.3 templates and copy them to 7.2 -- or otherwise
        hardcode the version your using to pick up the 7.3 templates </p></li>
<li><p>Remove all traces of schemas from the code and sql templates. I
        basically changed the "." to an "_". </p></li>
<li><p> Bunch of work related to the XID datatype and functions. For
        example, Slony creates CASTs for the xid to xxid and back -- but
        7.2 cannot create new casts that way so you need to edit system
        tables by hand. I recall creating an Operator Class and editing
        several functions as well. </p></li>
<li><p>sl_log_1 will have severe performance problems with any kind of
        data volume. This required a number of index and query changes
        to optimize for 7.2. 7.3 and above are quite a bit smarter in
        terms of optimizations they can apply. </p></li>
<li><p> Don't bother trying to make sequences work. Do them by hand
        after the upgrade using pg_dump and grep. </p></li>
</ul></div>
<p> Of course, now that you have done all of the above, it's not compatible
with standard Slony now. So you either need to implement 7.2 in a less
hackish way, or you can also hack up slony to work without schemas on
newer versions of PostgreSQL so they can talk to each other.</p>
<p> Almost immediately after getting the DB upgraded from 7.2 to 7.4, we
deinstalled the hacked up Slony (by hand for the most part), and started
a migration from 7.4 to 7.4 on a different machine using the regular
Slony. This was primarily to ensure we didn't keep our system catalogues
which had been manually fiddled with.</p>
<p> All that said, we upgraded a few hundred GB from 7.2 to 7.4
with about 30 minutes actual downtime (versus 48 hours for a dump /
restore cycle) and no data loss.</p>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"><b></b></td>
<td align="left" valign="top">
<p> That represents a sufficiently ugly set of
&#8220;<span class="quote">hackery</span>&#8221; that the developers are exceedingly reluctant
to let it anywhere near to the production code.  If someone were
interested in &#8220;<span class="quote">productionizing</span>&#8221; this, it would probably
make sense to do so based on the <span class="productname">Slony-I</span> 1.0 branch, with the express
plan of <span class="emphasis"><em>not</em></span> trying to keep much in the way of
forwards compatibility or long term maintainability of replicas.</p>
<p> You should only head down this road if you are sufficiently
comfortable with <span class="productname">PostgreSQL</span> and <span class="productname">Slony-I</span> that you are prepared to hack
pretty heavily with the code.  </p>
</td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2550392"></a><a name="id2550393"></a><b>37.</b>
</td>
<td align="left" valign="top"><p> I am finding some multibyte columns (Unicode, Big5)
are being truncated.  Why?  </p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"><b></b></td>
<td align="left" valign="top"><p> This was a bug present until a little after <span class="productname">Slony-I</span>
version 1.1.0; the way in which columns were being captured by the
<tt class="function">logtrigger()</tt> function could clip off the last
byte of a column represented in a multibyte format.  Check to see that
your version of <tt class="filename">src/backend/slony1_funcs.c</tt> is
1.34 or better; the patch was introduced in CVS version 1.34 of that
file.  </p></td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2550424"></a><a name="id2550425"></a><b>38.</b>
</td>
<td align="left" valign="top"><p> I need to rename a column that is in the
primary key for one of my replicated tables.  That seems pretty
dangerous, doesn't it?  I have to drop the table out of replication
and recreate it, right?</p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"><b></b></td>
<td align="left" valign="top">
<p> Actually, this is a scenario which works out remarkably
cleanly.  <span class="productname">Slony-I</span> does indeed make intense use of the primary key
columns, but actually does so in a manner that allows this sort of
change to be made very nearly transparently.</p>
<p> Suppose you revise a column name, as with the SQL DDL <tt class="command">alter table accounts alter column aid rename to cid; </tt> This
revises the names of the columns in the table; it
<span class="emphasis"><em>simultaneously</em></span> renames the names of the columns
in the primary key index.  The result is that the normal course of
things is that altering a column name affects both aspects
simultaneously on a given node.</p>
<p> The <span class="emphasis"><em>ideal</em></span> and proper handling of this
change would involve using <a href="stmtddlscript.html" title="EXECUTE SCRIPT"><span class="refentrytitle">EXECUTE SCRIPT</span></a> to deploy
the alteration, which ensures it is applied at exactly the right point
in the transaction stream on each node.</p>
<p> Interestingly, that isn't forcibly necessary.  As long as the
alteration is applied on the replication set's origin before
application on subscribers, things won't break irrepairably.  Some
<tt class="command">SYNC</tt> events that do not include changes to the
altered table can make it through without any difficulty...  At the
point that the first update to the table is drawn in by a subscriber,
<span class="emphasis"><em>that</em></span> is the point at which
<tt class="command">SYNC</tt> events will start to fail, as the provider
will indicate the &#8220;<span class="quote">new</span>&#8221; set of columns whilst the
subscriber still has the &#8220;<span class="quote">old</span>&#8221; ones.  If you then apply
the alteration to the subscriber, it can retry the
<tt class="command">SYNC</tt>, at which point it will, finding the
&#8220;<span class="quote">new</span>&#8221; column names, work just fine.</p>
</td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2550522"></a><a name="id2550523"></a><b>39.</b>
</td>
<td align="left" valign="top"><p> Replication has fallen behind, and it appears that the
queries to draw data from <a href="table.sl-log-1.html">sl_log_1</a>/<a href="table.sl-log-2.html">sl_log_2</a> are taking a long time to pull just a few
<tt class="command">SYNC</tt>s. </p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"><b></b></td>
<td align="left" valign="top"><p> Until version 1.1.1, there was only one index on <a href="table.sl-log-1.html">sl_log_1</a>/<a href="table.sl-log-2.html">sl_log_2</a>, and if
there were multiple replication sets, some of the columns on the index
would not provide meaningful selectivity.  If there is no index on
column <tt class="function"> log_xid</tt>, consider adding it.  See
<tt class="filename">slony1_base.sql</tt> for an example of how to create
the index.</p></td>
</tr>
</tbody>
</table>
</div>
</div></body>
</html>
