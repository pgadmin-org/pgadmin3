<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>29.13. Internals</title>
<link rel="stylesheet" href="stylesheet.css" type="text/css">
<link rev="made" href="pgsql-docs@postgresql.org">
<meta name="generator" content="DocBook XSL Stylesheets V1.64.1">
<link rel="home" href="index.html" title="PostgreSQL 8.0.0beta2 Documentation">
<link rel="up" href="ecpg.html" title="Chapter 29. ECPG - Embedded SQL in C">
<link rel="previous" href="ecpg-library.html" title="29.12. Library Functions">
<link rel="next" href="information-schema.html" title="Chapter 30. The Information Schema">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="sect1" lang="en">
<div class="titlepage">
<div><div><h2 class="title" style="clear: both">
<a name="ecpg-develop"></a>29.13. Internals</h2></div></div>
<div></div>
</div>
<p>   This section explain how <span class="application">ECPG</span> works
   internally. This information can occasionally be useful to help
   users understand how to use <span class="application">ECPG</span>.
  </p>
<p>    The first four lines written by <tt class="command">ecpg</tt> to the
    output are fixed lines.  Two are comments and two are include
    lines necessary to interface to the library.  Then the
    preprocessor reads through the file and writes output.  Normally
    it just echoes everything to the output.
   </p>
<p>    When it sees an <tt class="command">EXEC SQL</tt> statement, it
    intervenes and changes it. The command starts with <tt class="command">EXEC
    SQL</tt> and ends with <tt class="command">;</tt>. Everything in
    between is treated as an <span class="acronym">SQL</span> statement and
    parsed for variable substitution.
   </p>
<p>    Variable substitution occurs when a symbol starts with a colon
    (<tt class="literal">:</tt>). The variable with that name is looked up
    among the variables that were previously declared within a
    <tt class="literal">EXEC SQL DECLARE</tt> section.
   </p>
<p>    The most important function in the library is
    <tt class="function">ECPGdo</tt>, which takes care of executing most
    commands. It takes a variable number of arguments. This can easily
    add up to 50 or so arguments, and we hope this will not be a
    problem on any platform.
   </p>
<p>    The arguments are:

    </p>
<div class="variablelist"><dl>
<dt><span class="term">A line number</span></dt>
<dd><p>        This is the line number of the original line; used in error
        messages only.
       </p></dd>
<dt><span class="term">A string</span></dt>
<dd><p>        This is the <span class="acronym">SQL</span> command that is to be issued.
        It is modified by the input variables, i.e., the variables that
        where not known at compile time but are to be entered in the
        command. Where the variables should go the string contains
        <tt class="literal">?</tt>.
       </p></dd>
<dt><span class="term">Input variables</span></dt>
<dd><p>        Every input variable causes ten arguments to be created.  (See below.)
       </p></dd>
<dt><span class="term"><i class="parameter"><tt>ECPGt_EOIT</tt></i></span></dt>
<dd><p>        An <tt class="type">enum</tt> telling that there are no more input
        variables.
       </p></dd>
<dt><span class="term">Output variables</span></dt>
<dd><p>        Every output variable causes ten arguments to be created.
        (See below.)  These variables are filled by the function.
       </p></dd>
<dt><span class="term"><i class="parameter"><tt>ECPGt_EORT</tt></i></span></dt>
<dd><p>        An <tt class="type">enum</tt> telling that there are no more variables.
       </p></dd>
</dl></div>
<p>
   </p>
<p>    For every variable that is part of the <span class="acronym">SQL</span>
    command, the function gets ten arguments:

    </p>
<div class="orderedlist"><ol type="1">
<li><p>       The type as a special symbol.
      </p></li>
<li><p> 
       A pointer to the value or a pointer to the pointer.
      </p></li>
<li><p>       The size of the variable if it is a <tt class="type">char</tt> or <tt class="type">varchar</tt>.
      </p></li>
<li><p>       The number of elements in the array (for array fetches).
      </p></li>
<li><p>       The offset to the next element in the array (for array fetches).
      </p></li>
<li><p>       The type of the indicator variable as a special symbol.
      </p></li>
<li><p>       A pointer to the indicator variable.
      </p></li>
<li><p>       0
      </p></li>
<li><p>       The number of elements in the indicator array (for array fetches).
      </p></li>
<li><p>       The offset to the next element in the indicator array (for
       array fetches).
      </p></li>
</ol></div>
<p>
   </p>
<p>    Note that not all SQL commands are treated in this way.  For
    instance, an open cursor statement like
</p>
<pre class="programlisting">EXEC SQL OPEN <i class="replaceable"><tt>cursor</tt></i>;</pre>
<p>
    is not copied to the output. Instead, the cursor's
    <tt class="command">DECLARE</tt> command is used at the position of the <tt class="command">OPEN</tt> command
    because it indeed opens the cursor.
   </p>
<p>    Here is a complete example describing the output of the
    preprocessor of a file <tt class="filename">foo.pgc</tt> (details may
    change with each particular version of the preprocessor):
</p>
<pre class="programlisting">EXEC SQL BEGIN DECLARE SECTION;
int index;
int result;
EXEC SQL END DECLARE SECTION;
...
EXEC SQL SELECT res INTO :result FROM mytable WHERE index = :index;</pre>
<p>
    is translated into:
</p>
<pre class="programlisting">/* Processed by ecpg (2.6.0) */
/* These two include files are added by the preprocessor */
#include &lt;ecpgtype.h&gt;;
#include &lt;ecpglib.h&gt;;

/* exec sql begin declare section */

#line 1 "foo.pgc"

 int index;
 int result;
/* exec sql end declare section */
...
ECPGdo(__LINE__, NULL, "SELECT res FROM mytable WHERE index = ?     ",
        ECPGt_int,&amp;(index),1L,1L,sizeof(int),
        ECPGt_NO_INDICATOR, NULL , 0L, 0L, 0L, ECPGt_EOIT,
        ECPGt_int,&amp;(result),1L,1L,sizeof(int),
        ECPGt_NO_INDICATOR, NULL , 0L, 0L, 0L, ECPGt_EORT);
#line 147 "foo.pgc"</pre>
<p>
    (The indentation here is added for readability and not
    something the preprocessor does.)
   </p>
</div></body>
</html>
